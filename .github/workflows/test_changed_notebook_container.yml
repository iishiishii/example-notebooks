# This workflows executes new or modified example notebooks.

name: test_changed_notebooks_container

defaults:
  run:
    shell: bash  # To override PowerShell on Windows

on:
  # Trigger the workflow on push or PR to any branch
  push:
    paths:
      - '**/*.ipynb'
      - 'books/*.md'
  pull_request:
    paths:
      - '**/*.ipynb'
      - 'books/*.md'
    # don't trigger for draft PRs
    types: [ opened, synchronize, reopened, ready_for_review ]
  # Trigger the workflow on manual dispatch
  workflow_dispatch:
    inputs:
      image_override:
        description: 'Override the Docker image (e.g. ghcr.io/neurodesk/neurodesktop/neurodesktop:2024-01-01)'
        required: false
        type: string
      force_execution:
        description: 'Force execution of all notebooks'
        required: false
        type: boolean
        default: false
      force_deploy_pages:
        description: 'Force deploy pages'
        required: false
        type: boolean
        default: false
      notebook_selector:
        description: 'Select a specific notebook to run (e.g. workflows/nipype_short.ipynb)'
        required: false
        type: string

jobs:
  select-runner:
    runs-on: ubuntu-22.04
    outputs:
      runner: ${{ steps.select_runner.outputs.runner }}
      neurodesk_image: ${{ steps.get_image.outputs.neurodesk_image }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Select runner
        id: select_runner
        run: |
          if [ "${{ github.repository }}" = "neurodesk/example-notebooks" ]; then
            echo "runner=self-hosted" >> $GITHUB_OUTPUT
          else
            echo "runner=ubuntu-22.04" >> $GITHUB_OUTPUT
          fi
      - name: Get Neurodesk Image
        id: get_image
        run: |
          if [ -n "${{ inputs.image_override }}" ]; then
            echo "neurodesk_image=${{ inputs.image_override }}" >> $GITHUB_OUTPUT
          else
            curl -s https://raw.githubusercontent.com/neurodesk/neurodesk.github.io/main/data/neurodesktop.toml -o neurodesktop.toml
            VERSION=$(grep 'jupyter_neurodesk_version = ' neurodesktop.toml | cut -d '"' -f 2)
            echo "neurodesk_image=ghcr.io/neurodesk/neurodesktop/neurodesktop:$VERSION" >> $GITHUB_OUTPUT
          fi
          
  get-notebooks:
    runs-on: ubuntu-22.04
    outputs:
      notebook_list: ${{ steps.list_changed_notebooks.outputs.notebook_list }}
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
    - name: Find all notebooks with changes
      id: find_changed_notebooks
      uses: tj-actions/changed-files@c3a1bb2c992d77180ae65be6ae6c166cf40f857c
      with:
        path: "./books"
        files: |
          **/*.ipynb
          *.md
        dir_names_exclude_current_dir: "true"
    - name: Filter down to changed notebooks
      id: list_changed_notebooks
      run: |
        if [ "${{ inputs.force_execution }}" == "true" ]; then
          echo "Forcing execution of all notebooks"
          # Find all notebooks and remove the leading ./books/ prefix if present, or just ./
          changed_notebooks=$(find books -name "*.ipynb" | sed 's|^books/||')
        elif [ -n "${{ inputs.notebook_selector }}" ]; then
          echo "Selecting specific notebook: ${{ inputs.notebook_selector }}"
          changed_notebooks="${{ inputs.notebook_selector }}"
        else
          echo ${{ steps.find_changed_notebooks.outputs.all_changed_files }}
          changed_notebooks=$(echo "${{ steps.find_changed_notebooks.outputs.all_changed_files }}")
        fi
        
        notebook_list='['
        for NOTEBOOK in $(echo "${changed_notebooks}"); do
          notebook_list+="\"${NOTEBOOK}\","
        done
        notebook_list=$(sed '$s/,$//' <<< $notebook_list)
        notebook_list+=']'
        echo "notebook_list=${notebook_list}"
        echo "notebook_list=${notebook_list}" >> $GITHUB_OUTPUT

  test-notebooks:
    needs: [ select-runner, get-notebooks ]
    if: ${{ needs.get-notebooks.outputs.notebook_list != '[]' }}
    runs-on: ${{ needs.select-runner.outputs.runner }}
    timeout-minutes: 1500
    strategy:
      fail-fast: true
      matrix:
        notebooks: ${{ fromJson(needs.get-notebooks.outputs.notebook_list) }}
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
    - name: Start Neurodesk Container
      run: |
        docker run -d --name nb-runner \
          --user root --privileged --shm-size=1gb \
          -e NB_UID=1001 -e NB_GID=1001 \
          -v /home/runner/:/home/ \
          -v neurodesk-home:/home/jovyan \
          -v ${{ github.workspace }}:${{ github.workspace }} \
          ${{ needs.select-runner.outputs.neurodesk_image }} \
          tail -f /dev/null

    - name: Install dependencies
      shell: bash
      run: |
        docker exec nb-runner bash -c "pip install -y papermill ghp-import"

    - name: Run ${{ matrix.notebooks }}
      shell: bash
      timeout-minutes: 1500
      working-directory: ./books
      env: 
        GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e
        set -o pipefail

        echo ${{ github.workspace }}
        echo $GITHUB_WORKSPACE
        
        NOTEBOOK_PATH="${{ matrix.notebooks }}"
        NOTEBOOK_BASE="$(basename -s .ipynb "$NOTEBOOK_PATH")"
        NOTEBOOK_DIR="$(dirname "$NOTEBOOK_PATH")"
        NOTEBOOK_OUTPUT="${NOTEBOOK_DIR}/${NOTEBOOK_BASE}_out.ipynb"
        NOTEBOOK_ARTIFACT="${NOTEBOOK_BASE}_out"   # Safe artifact name (no slashes)

        echo "NOTEBOOK_PATH=$NOTEBOOK_PATH" >> $GITHUB_ENV
        echo "NOTEBOOK_BASE=$NOTEBOOK_BASE" >> $GITHUB_ENV
        echo "NOTEBOOK_DIR=$NOTEBOOK_DIR" >> $GITHUB_ENV
        echo "NOTEBOOK_OUTPUT=$NOTEBOOK_OUTPUT" >> $GITHUB_ENV
        echo "NOTEBOOK_ARTIFACT=$NOTEBOOK_ARTIFACT" >> $GITHUB_ENV
        echo "CURRENT_DIR=$(pwd)" >> $GITHUB_ENV

        docker exec -e GITHUB_PAT=$GITHUB_PAT \
          -w ${{ github.workspace }}/books \
          nb-runner bash -c "export PATH=/opt/conda/bin:\$HOME/.local/bin:\$PATH && papermill \"$NOTEBOOK_PATH\" \"$NOTEBOOK_OUTPUT\" --kernel python3"

    - name: Check Notebook Execution Result
      if: always()
      working-directory: ./books
      env:
        ERROR_PATTERNS: "SyntaxError,Traceback,EOFError,NameError,Exception,ModuleNotFoundError,ImportError,OSError,FileNotFoundError,IndentationError,ValueError,TypeError,AttributeError,KeyError,ZeroDivisionError,RuntimeError,MemoryError,TimeoutError,IndexError,PermissionError,Cell execution timed out,Killed,FAILED,Failing,Aborted,Segmentation fault,Kernel Restarting,EnvironmentError,ConnectionError,HTTPError,NotJSONError"
      run: |
        set -e

        # Check if output file exists
        ls -la $NOTEBOOK_OUTPUT
        
        # Split patterns into array
        IFS=',' read -ra ERROR_PATTERNS_ARR <<< "${ERROR_PATTERNS}"

        echo ""
        echo "Checking for error patterns in output (case-insensitive)..."
        ERROR_FOUND=0
        for pattern in "${ERROR_PATTERNS_ARR[@]}"; do
            if error_lines=$(grep -i "${pattern// /}" "$NOTEBOOK_OUTPUT") && [ -n "$error_lines" ]; then
                echo "⚠️ Found error pattern: $pattern"
                echo "Error lines: $error_lines"
                ERROR_FOUND=$((ERROR_FOUND + 1))
            fi
        done
        
        # Check papermill metadata for exceptions
        resp=$(cat "$NOTEBOOK_OUTPUT")
        exception=$(echo "$resp" | jq -r '.metadata.papermill.exception // empty')
        if [[ -n "$exception" ]]; then
            echo "⚠️ Found papermill exception: $exception"
            ERROR_FOUND=$((ERROR_FOUND + 1))
        fi

        echo "ERROR_FOUND=$ERROR_FOUND" >> $GITHUB_ENV
        echo "ERROR_PATTERNS_TOTAL=${#ERROR_PATTERNS_ARR[@]}" >> $GITHUB_ENV

        if [ $ERROR_FOUND -eq 0 ]; then
            echo "✅ Notebook execution successful! ($ERROR_FOUND/${#ERROR_PATTERNS_ARR[@]} error patterns found)"
            echo "NOTEBOOK_SUCCESS=true" >> $GITHUB_ENV
        else
            echo "❌ Notebook execution may have failed ($ERROR_FOUND/${#ERROR_PATTERNS_ARR[@]} error patterns found)"
            echo "NOTEBOOK_SUCCESS=false" >> $GITHUB_ENV
        fi

    - name: Upload output notebook as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.NOTEBOOK_ARTIFACT }}
        path: ${{ env.CURRENT_DIR }}/${{ env.NOTEBOOK_OUTPUT }}

    - name: Clean build dir
      run: |
        rm -rf /home/ubuntu/actions_github_pages_*

  build-structure:
    if: ${{ needs.test-notebooks.result != 'failure' }}
    needs: [ test-notebooks, select-runner ]
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
    - name: Start Neurodesk Container
      run: |
        docker run -d --name nb-runner \
          --user root --privileged --shm-size=1gb \
          -e NB_UID=1001 -e NB_GID=1001 \
          -v /home/runner/:/home/ \
          -v neurodesk-home:/home/jovyan \
          -v ${{ github.workspace }}:${{ github.workspace }} \
          ${{ needs.select-runner.outputs.neurodesk_image }} \
          tail -f /dev/null

    - name: Install dependencies
      shell: bash
      run: |
        docker exec nb-runner bash -c "mamba install -c pypi 'jupyter-book<2.0.0' ghp-import"

    - name: Run all
      shell: bash
      working-directory: ./books
      env: 
        GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      run: |
        docker exec -e GITHUB_PAT=$GITHUB_PAT \
          -w ${{ github.workspace }}/books \
          nb-runner bash -c "export PATH=/opt/conda/bin:\$HOME/.local/bin:\$PATH && /bin/bash ../.github/scripts/write-toc-entry.sh && sed -i 's/execute_notebooks: .*/execute_notebooks: off/' _config.yml && cat _config.yml && jupyter-book build ."


    - name: Push to GitHub Pages
      uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e
      if: github.event_name != 'pull_request' && (github.event_name != 'workflow_dispatch' || inputs.force_deploy_pages == true)
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./books/_build/html
        keep_files: true
        cname: neurodesk.org